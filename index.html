<!DOCTYPE  html>
<html>
<head>
<title>Test API Google Maps</title>
<meta name="viewport" content="initial-scale=1.0, user-scalable=no, width=device-width" />
<meta http-equiv="content-type" content="text/html; charset=UTF-8" />
<style type="text/css">
@media (max-width: 700px){
	#legende{
	font-size: 6px;
	marging: 0;
	padding: 0;
	}
	
	input[type='checkbox'] {
	margin: 0;
	padding: 0;
	width: 8px;
	height: 8px;
	}
	
	#titreLegende {
	font-size: 9px;
	margin: 5px;
	padding: 0;
	}
	
	#blocLegende {
	margin: 0;
	padding: 0;
	}
}

html {
height: 100%;
}

body {
height: 100%;
width: 100%;
margin: 0px;
padding: 0px;
over-flow: auto;
}

h1 { 
font-size: 20px;
text-align: center;
margin-bottom: 20px;
}

#map_canvas {
height: 100%;
z-index: 0;
}

#blocLegende {
background-color: white;
opacity: 0.8;
position: absolute;
left: 20px;
top: 20px;
width: 20%;
min-width: 100px;
max-width: 350px;
z-index: 1;
border-radius:16px;
padding-right:10px;
padding-left:10px;
padding-bottom:10px;
}

input[type='checkbox'] {
margin-bottom: 10px;
}

#logo {
position: absolute;
right: 0px;
bottom: 13px;
z-index: 1;
width: 150px;
background-color: white;
opacity: 0.8;
}

a img {
border: 0;
}

.infoWindow * {
padding: 0;
margin: 0;
width: 200px;
}

.type {
font-size: 10px;
margin-bottom: 3px;
}

#listeAttributs {
margin-top: 10px;
}

</style>
<script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false" ></script>


<script type="text/javascript">
	
function initialize() {

	// import de la carte OSM(Mapnik)
	
	osmMapType = new google.maps.ImageMapType({
		getTileUrl: function(coord, zoom) {
			return "http://tile.openstreetmap.org/" +
			zoom + "/" + coord.x + "/" + coord.y + ".png";
		},
		tileSize: new google.maps.Size(256, 256),
		isPng: true,
		alt: "OpenStreetMap Mapnik layer",
		name: "OSM",
		maxZoom: 20
	});

	// import de la carte MapQuest
	
	mapQuestType = new google.maps.ImageMapType({
		getTileUrl: function(coord, zoom) {
			return "http://otile1.mqcdn.com/tiles/1.0.0/map/" +
			zoom + "/" + coord.x + "/" + coord.y + ".png";
		},
		tileSize: new google.maps.Size(256, 256),
		isPng: true,
		alt: "MapQuest layer (données OSM)",
		name: "MapQuest",
		maxZoom: 20
	});
	
	// chargement de l'application avec ses options
	
	var latlng = new google.maps.LatLng(50.3607, 3.5042);
	var myOptions = {
		zoom: 14,
		minZoom: 13,
		maxZoom: 18,
		center: latlng,
		disableDefaultUI: true,
		mapTypeControl: true,
		mapTypeControlOptions: {mapTypeIds: [google.maps.MapTypeId.ROADMAP,google.maps.MapTypeId.SATELLITE,'OSM','MapQuest'],style: google.maps.MapTypeControlStyle.DROPDOWN_MENU},
		streetViewControl: true,
		streetViewControlOptions: {position: google.maps.ControlPosition.RIGHT_TOP},
		scaleControl: true,
		zoomControl: true,
		zoomControlOptions: {position: google.maps.ControlPosition.RIGHT_TOP},
		mapTypeId: 'MapQuest'
	};
	map = new google.maps.Map(document.getElementById("map_canvas"), myOptions);
	map.mapTypes.set('OSM',osmMapType);
	map.mapTypes.set('MapQuest',mapQuestType);

	// fonction pour supprimer une infowindow ouverte et/ou l'animation d'un marqueur
	
	function resetInfAni(){
	
		// si une fenêtre d'information est déjà ouverte, on la ferme
		
		if (typeof infoWindow != 'undefined') {
			infoWindow.close();
		};
		
		// s'il y a encore un marker animé, le supprimer et remettre le feature d'origine
		
		if (typeof marker != 'undefined' && marker.getMap() != 'null') {
			featureAnim.setGeometry({lat:latFeat,lng:lngFeat});
			marker.setMap(null);
		};
	};
	
	// fonction pour répartir les entités selon différentes couches selon leur type
	
	function splitData(AddFeatureEvent){
		var feature = AddFeatureEvent.feature;
		var genre = feature.getProperty("Genre");
		var layer_index = (!layers[genre] || layers[genre]===undefined) ? "problems" : genre;
		layers[layer_index][0].add(feature);
	};
	
	// fonction lancée quand une checkbox est activée/désactivée
	
	function chbChange(event){
	
		// si une fenêtre d'information est déjà ouverte ou un marqueur animé on les ferme
		
		resetInfAni();
		
		// affichage ou désactivation de la couche concernée
		
		var elemInd = event.target.name;
		var elemChk = event.target.checked;
		if (elemChk) {
			layers[elemInd][0].setMap(map);
		}
		else {
			layers[elemInd][0].setMap(null);
		};	
	};
	
	// fonction lancée quand il y a un clic sur une entité
	
	function clic(event){
		
		// si une fenêtre d'information est déjà ouverte ou un marqueur animé on les ferme
		
		resetInfAni();
		
		// construction du code HTML à insérer dans la fenêtre d'information avec des règles de conditions (si numéro = 0 alors on ne l'affiche pas, etc.)
		
		var htmlInfo = '<div class="infoWindow">\n<h3>' + event.feature.getProperty("Libelle") + '</h3>\n' + '<p class="type"><em>Type : ' +
		layers[event.feature.getProperty("Genre")][2] + '</em></p>\n<hr>\n<ul id="listeAttributs">\n' + '<li><b>Adresse :</b> ';
		if (event.feature.getProperty("Num_1")!=0) {
		htmlInfo = htmlInfo + event.feature.getProperty("Num_1");
		};
		if (event.feature.getProperty("Typ_Voie")) {
		htmlInfo = htmlInfo + ' ' +	event.feature.getProperty("Typ_Voie");
		};
		if (event.feature.getProperty("Voie")) {
		htmlInfo = htmlInfo + ' ' + event.feature.getProperty("Voie") + '</li>\n</ul>\n</div>';
		};
		
		// création et ouverture de la fenêtre d'information

		infoWindow = new google.maps.InfoWindow({ content: htmlInfo, position: event.latLng, pixelOffset: {width:0, height:-40}});
		infoWindow.open(map);
		infoWindow.addListener("closeclick",resetInfAni);
		
		// animation de l'icone
		
		latFeat = event.latLng.lat();
		lngFeat = event.latLng.lng();
		featureAnim = event.feature;
		featureAnim.setGeometry(0,0); // je déplace le feature pour qu'il ne soit plus visible sur la carte
		marker = new google.maps.Marker({position:{lat:latFeat,lng:lngFeat},map:map,icon:layers[featureAnim.getProperty("Genre")][1],animation: google.maps.Animation.BOUNCE}); // je créé un marker animé qui le remplace
		
		// Si on veut que l'animation s'arrête au bout d'un moment :
		/*setTimeout(function(){
			marker.setMap(null);
			featureAnim.setGeometry({lat:latFeat,lng:lngFeat});
			},2850);*/
	};
	
	// Création des couches thématiques dans un objet contenant plusieurs array : [0] = création de l'objet Data ; [1] = lien logo ; [2] = Nom à afficher dans la légende
	
	layers = {
		administratif: [ new google.maps.Data(), "http://chart.apis.google.com/chart?chst=d_map_pin_letter&chld=%E2%80%A2|176dee" , "Administratif"],
		associatif: [ new google.maps.Data(), "http://chart.apis.google.com/chart?chst=d_map_pin_letter&chld=%E2%80%A2|d4412c" , "Associatif"],
		culture: [ new google.maps.Data(), "http://chart.apis.google.com/chart?chst=d_map_pin_letter&chld=%E2%80%A2|009b58" , "Culturels"],
		ecole: [ new google.maps.Data(), "http://chart.apis.google.com/chart?chst=d_map_pin_letter&chld=%E2%80%A2|07f7e9" , "Écoles"],
		petite_enfance: [ new google.maps.Data(), "http://chart.apis.google.com/chart?chst=d_map_pin_letter&chld=%E2%80%A2|38ed00" , "Petite enfance"],
		social: [ new google.maps.Data(), "http://chart.apis.google.com/chart?chst=d_map_pin_letter&chld=%E2%80%A2|f39b1d" , "Social"],
		sports: [ new google.maps.Data(), "http://chart.apis.google.com/chart?chst=d_map_pin_letter&chld=%E2%80%A2|a63e0b" , "Sports"],
		cultuel: [ new google.maps.Data(), "http://chart.apis.google.com/chart?chst=d_map_pin_letter&chld=%E2%80%A2|ffb606" , "Religieux"],
		divers: [ new google.maps.Data(), "http://chart.apis.google.com/chart?chst=d_map_pin_letter&chld=%E2%80%A2|ed21d3" ,  "Divers"]
	};
	
	var htmlLegende = ''; // variable accueillant le code HTML qui va créer la légende
	
	for (index in layers){
		layers[index][0].setMap(map); // affichage des couches sur la carte
		layers[index][0].setStyle({icon:layers[index][1]}); // défini l'icone de chaque couche
		layers[index][0].addListener('click',clic); // ajout d'un événement clic sur les entités
		htmlLegende = htmlLegende + '<input type="checkbox" name="' + index + '" checked="checked">' + layers[index][2] + '<BR>\n'; // construit le code HTML de la légende
		
	};
	
	// intégration du code de la légende dans le HTML
	
	document.getElementById("legende").innerHTML=htmlLegende;
	
	// ajout des événement sur les checkbox
	
	for (index in layers){
		document.getElementsByName(index)[0].addEventListener("change",chbChange);
	};

	
	// import de toutes les données du GeoJson et de l'évenement à chaque ajout dans data1
	
	data1 = new google.maps.Data();
	data1.addListener('addfeature',splitData);
	data1.loadGeoJson('bati.geojson');
	
	// import du masque des communes voisines
	
	dataCom = new google.maps.Data();
	dataCom.loadGeoJson('com.geojson');
	dataCom.setStyle({fillOpacity:0.4,strokeWeight:0.5,strokeColor:"white",clickable:false});
	dataCom.setMap(map);
	
}

</script>
</head>
<body onload="initialize()">
<div id="map_canvas"></div>
<div id="blocLegende">
	<h1 id="titreLegende">Les bâtiments communaux de Valenciennes</h1>
	<form id="legende">
	</form>
</div>
<a href="http://www.valenciennes.fr/"><img id="logo" src="logo.png"></a>
</body>
</html>
